name: Real-time Signal Detection

on:
  push:
    branches: [main]
  schedule:
    - cron: '*/5 * * * *'  # Check every 5 minutes for real-time signals
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-signals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for trading signals
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from modules.data_fetcher import get_latest_data
          from modules.trading_logic import detect_signal
          from modules.email_service import send_email
          import os
          
          # Fetch latest market data
          data = get_latest_data()
          
          # Check for trading signals
          signal = detect_signal(data)
          
          if signal:
              # Send email notification immediately on signal
              sender = os.getenv('SENDER_EMAIL')
              recipient = os.getenv('RECIPIENT_EMAIL')
              password = os.getenv('SENDER_PASSWORD')
              
              send_email(
                  sender=sender,
                  recipient=recipient,
                  password=password,
                  subject=f'Trading Signal Detected: {signal}',
                  body=f'A trading signal has been detected:\n\nSignal Type: {signal}\nTime: {data[\"timestamp\"]}\nPrice: {data[\"price\"]}'  
              )
              print(f'Signal detected and email sent: {signal}')
          else:
              print('No signal detected')
          "

name: Lightweight Charts Signal Detection - 17:30

on:
  schedule:
    # Daily signal check at 17:30 CET (16:30 UTC)
    # Using Lightweight Charts data for precise signal analysis
    - cron: '30 16 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-signals:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Lightweight Charts signals at 17:30 CET
        env:
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        run: |
          python -c "
          import sys
          import datetime
          sys.path.insert(0, '.')
          from modules.data_fetcher import get_latest_data
          from modules.trading_logic import detect_signal
          from modules.email_service import send_email
          import os
          
          # Log execution time (17:30 CET)
          now = datetime.datetime.now(datetime.timezone.utc)
          print(f'Signal check execution: {now.isoformat()} UTC')
          
          # Fetch latest Lightweight Charts data
          data = get_latest_data()
          
          # Analyze for trading signals using Lightweight Charts precision
          signal = detect_signal(data)
          
          if signal:
              # Send email notification at 17:30 CET
              sender = os.getenv('SENDER_EMAIL')
              recipient = os.getenv('RECIPIENT_EMAIL')
              password = os.getenv('SENDER_PASSWORD')
              
              send_email(
                  sender=sender,
                  recipient=recipient,
                  password=password,
                  subject=f'[17:30 CET] Lightweight Charts Signal: {signal}',
                  body=f'Trading signal detected at 17:30 CET via Lightweight Charts:\n\nSignal Type: {signal}\nTime: {data[\"timestamp\"]}\nPrice: {data[\"price\"]}\n\nSystem: Lightweight Charts Precision Analysis'  
              )
              print(f'[17:30] Signal detected and email sent: {signal}')
          else:
              print('[17:30] No signal detected at scheduled time')
          "
